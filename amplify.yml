version: 1
applications:
  - appRoot: demos/timetrvlr/timetrvlr_client
    frontend:
      phases:
        preBuild:
          commands:
            - echo "Setting up Node 20"
            - export NODE_VERSION=20
            - '[ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"'
            - "nvm install $NODE_VERSION || nvm use $NODE_VERSION"
            - nvm use $NODE_VERSION
            - node -v
            - echo "Installing dependencies"
            - yarn install --frozen-lockfile || yarn install
        build:
          commands:
            - echo "Building Next.js"
            - yarn build
      environment:
        # Ensures Amplify monorepo build process can locate the Next.js app root
        AMPLIFY_MONOREPO_APP_ROOT: demos/timetrvlr/timetrvlr_client
        # Increase memory for large Next.js builds (optional)
        NODE_OPTIONS: --max_old_space_size=4096
      artifacts:
        # For Next.js, Amplify Hosting detects SSR automatically. Keeping .next ensures static assets are available.
        baseDirectory: .next
        files:
          - "**/*"
      cache:
        paths:
          - node_modules
          - .next/cache
